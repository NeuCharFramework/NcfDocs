# MCP 常见问题解答 (FAQ)

本文档收集了使用MCP模块时最常见的问题和解答，帮助开发者快速解决可能遇到的问题。

## 基本问题

### Q: MCP是什么？

**A:** MCP (Model Context Protocol) 是一种用于模型上下文交互的协议，它允许在不同的模型和平台之间进行无缝通信。在NCF框架中，MCP模块作为一个中间层，负责处理应用程序与AI模型之间的通信，使开发者可以更轻松地使用AI能力。

### Q: MCP与其他AI集成方式有什么区别？

**A:** MCP提供了更标准化和统一的方式来集成AI功能，主要区别包括：
- 提供了一套标准协议，使不同AI模型可以通过统一接口访问
- 内置函数调用能力，让AI可以调用系统功能
- 优化了与大型语言模型的交互方式
- 与Semantic Kernel等AI框架有原生集成支持
- 专为NCF框架优化，提供更好的扩展性和模块化支持

### Q: 使用MCP需要什么前置知识？

**A:** 使用MCP模块时，建议具备以下知识：
- .NET Core和C#开发基础
- NCF框架的基本概念和使用
- 基本的AI和大型语言模型概念
- RESTful API和HTTP通信基础

## 安装与配置

### Q: 如何验证MCP是否安装成功？

**A:** 您可以通过以下步骤验证MCP是否安装成功：
1. 启动NCF应用程序
2. 在浏览器中访问 `http://localhost:5000/sse/sse`（根据您的配置可能不同）
3. 如果MCP服务器正常启动，您会看到一个事件流连接成功的响应

### Q: 为什么我访问MCP端点时收到401未授权错误？

**A:** 这通常是因为缺少访问令牌或令牌验证失败。请检查以下几点：
1. 确认您在`appsettings.json`中设置了正确的`McpAccessToken`
2. 确认访问MCP端点时包含了正确的token参数，如：`http://localhost:5000/sse/sse?token=your-token`
3. 检查授权中间件是否正确配置

### Q: 为什么我的MCP服务无法启动？

**A:** MCP服务无法启动可能有多种原因：
1. 端口冲突 - 检查是否有其他程序占用了相同端口
2. 配置错误 - 检查`appsettings.json`中的配置信息
3. 依赖缺失 - 确保所有必要的NuGet包都已安装
4. 权限问题 - 确保应用有足够权限启动网络服务

### Q: 如何在生产环境中安全配置MCP？

**A:** 在生产环境中，建议采取以下安全措施：
1. 使用强密码作为`McpAccessToken`，并通过环境变量或密钥保管库注入
2. 配置HTTPS加密传输
3. 实现更复杂的身份验证机制，如JWT或OAuth
4. 限制可访问MCP端点的IP地址
5. 实现请求速率限制
6. 记录和监控所有MCP调用

## 开发与使用

### Q: 如何创建自定义MCP工具？

**A:** 创建自定义MCP工具的步骤如下：
1. 创建一个静态类或实例类，并标记`[McpServerToolType()]`属性
2. 在类中创建公共方法，并标记`[McpServerTool]`属性
3. 使用`[Description]`属性提供工具描述
4. 在方法中实现工具逻辑
5. 确保在应用启动时注册工具（通常通过`WithToolsFromAssembly()`或`WithTools<T>()`）

### Q: 我的工具方法不被AI模型调用，可能的原因是什么？

**A:** 如果您的工具没有被AI模型调用，请检查以下几点：
1. 确认工具方法有正确的标记（`[McpServerTool]`和`[Description]`）
2. 确认工具类有正确的标记（`[McpServerToolType()]`）
3. 确认工具已被注册到MCP服务器
4. 检查工具的描述是否清晰详细，使AI能够理解其用途
5. 确认参数类型是否合适，复杂参数类型可能会导致调用失败
6. 检查AI模型配置，确保已启用函数调用功能

### Q: 如何处理异步操作的MCP工具？

**A:** 对于需要执行异步操作的MCP工具，使用以下模式：
1. 定义异步方法，返回类型为`Task<string>`
2. 使用`async/await`模式处理异步操作
3. 确保正确处理异常，并返回有意义的错误消息

```csharp
[McpServerTool, Description("异步获取数据")]
public async Task<string> GetDataAsync(string source)
{
    try
    {
        var data = await FetchDataFromSourceAsync(source);
        return JsonSerializer.Serialize(data);
    }
    catch (Exception ex)
    {
        return $"错误：{ex.Message}";
    }
}
```

### Q: 如何在MCP工具中处理复杂参数类型？

**A:** 对于复杂参数，可以创建自定义类作为参数容器：
1. 定义一个包含所需属性的类
2. 使用属性标记提供参数描述和默认值
3. 在工具方法中使用该类作为参数

```csharp
public class SearchRequest
{
    [Required]
    [Description("搜索关键词")]
    public string Query { get; set; }
    
    [Description("最大结果数")]
    [DefaultValue(10)]
    public int MaxResults { get; set; }
    
    [Description("排序方式")]
    [DefaultValue("relevance")]
    public string SortBy { get; set; }
}

[McpServerTool, Description("执行搜索")]
public string Search(SearchRequest request)
{
    // 实现搜索逻辑
    return "搜索结果...";
}
```

## AI集成与工具调用

### Q: 如何监控AI模型是否正确调用了MCP工具？

**A:** 监控AI模型调用MCP工具的方式：
1. 实现日志记录，在工具方法中记录调用和参数
2. 使用应用性能监控工具跟踪调用频率和性能
3. 在工具方法开始和结束时添加调试输出
4. 创建专门的工具调用仪表板或报告

### Q: 如何优化AI模型与MCP工具的交互？

**A:** 优化AI与MCP工具交互的方法：
1. 提供详细而准确的工具描述
2. 使用具体的参数名称和描述
3. 为参数提供合理的默认值
4. 返回结构化且易于理解的结果
5. 适当调整AI模型的temperature和其他参数
6. 优化提示词，引导AI正确使用工具

### Q: 为什么AI有时会选择不调用我的工具？

**A:** AI选择不调用工具的可能原因：
1. 工具描述不够清晰或与当前任务无关
2. AI认为可以通过其知识库直接回答
3. 函数调用行为设置不当（如未设置为Required模式）
4. AI模型版本可能不支持或不擅长使用工具
5. 提示词没有明确要求使用工具

### Q: 如何确保AI始终使用我的工具？

**A:** 要确保AI使用您的工具：
1. 在函数设置中使用`FunctionChoiceBehavior.Required()`强制AI使用函数
2. 在提示中明确指示AI使用特定工具
3. 设计工具使其与特定任务高度相关
4. 使工具描述非常具体，与使用场景紧密关联

## 高级问题

### Q: 如何在多实例环境中配置MCP？

**A:** 在多实例或集群环境中，可以采用以下配置方式：
1. 使用共享缓存（如Redis）在实例间共享会话状态
2. 配置负载均衡器以支持会话亲和性
3. 使用分布式消息队列处理跨实例的MCP请求
4. 考虑使用服务网格（如Dapr）统一管理通信

### Q: MCP如何与NCF的其他模块集成？

**A:** MCP与其他NCF模块集成的方式：
1. 通过依赖注入引用其他模块的服务
2. 创建MCP工具包装其他模块的功能
3. 使用事件总线进行模块间通信
4. 利用NCF的OHS（开放主机服务）模式集成多个模块

### Q: 如何实现MCP的高可用性？

**A:** 实现MCP高可用性的策略：
1. 部署多个MCP服务实例
2. 实现健康检查和自动恢复
3. 使用容器编排（如Kubernetes）管理部署
4. 实现断路器模式处理故障
5. 使用缓存减轻服务器负载
6. 实施超时和重试策略

### Q: 如何扩展MCP功能，支持更多AI提供商？

**A:** 扩展MCP支持其他AI提供商的方法：
1. 实现自定义`AIModelProvider`接口
2. 为新提供商创建适配器类
3. 注册新提供商到服务容器
4. 在配置中添加新提供商的设置
5. 创建专用的工具集支持新提供商的特性

## 性能与优化

### Q: MCP有哪些性能考虑因素？

**A:** 使用MCP时的主要性能考虑因素：
1. AI模型调用的延迟，尤其是外部AI服务
2. 工具方法的执行时间
3. 数据序列化和反序列化的开销
4. 网络传输延迟
5. 并发请求处理能力
6. 内存使用，特别是大型会话和上下文

### Q: 如何优化高频率调用的MCP工具？

**A:** 优化高频调用工具的策略：
1. 实现结果缓存
2. 使用异步和并行处理
3. 批处理请求
4. 优化数据结构和算法
5. 使用高性能序列化（如System.Text.Json或MessagePack）
6. 考虑后台作业处理耗时操作

### Q: MCP服务有并发限制吗？

**A:** MCP服务的并发能力主要受以下因素限制：
1. 服务器硬件资源（CPU/内存）
2. AI服务提供商的API限制
3. NCF应用程序的整体配置
4. 网络带宽和连接数
5. 工具实现的效率

可以通过配置Web服务器、调整线程池设置和实现请求队列来管理并发负载。

## 故障排除

### Q: 如何调试MCP工具调用问题？

**A:** 调试MCP工具调用的方法：
1. 启用详细日志记录
2. 使用try/catch捕获并记录异常
3. 在工具方法中添加控制台输出或日志语句
4. 使用调试器附加到进程
5. 检查网络流量以分析请求和响应
6. 使用Postman或类似工具手动测试API

### Q: 常见的MCP错误码和解决方法？

**A:** 常见MCP错误及解决方案：

| 错误码 | 描述 | 解决方法 |
|-------|------|---------|
| 401 | 未授权 | 检查访问令牌配置 |
| 404 | 端点未找到 | 确认URL和路由配置 |
| 408 | 请求超时 | 增加超时设置或优化处理时间 |
| 429 | 请求过多 | 实现请求限流或增加服务容量 |
| 500 | 服务器错误 | 检查服务器日志，修复代码错误 |
| 503 | 服务不可用 | 检查依赖服务状态，确保AI服务可用 |

### Q: 如何解决AI模型理解工具用途的问题？

**A:** 改善AI对工具理解的方法：
1. 提供更详细和具体的工具描述
2. 使用通用和明确的术语
3. 为参数添加清晰的描述和示例
4. 测试不同的描述，找到最有效的表述
5. 在提示中提供使用工具的具体示例

通过以上问题和解答，希望能帮助您在使用MCP模块时更顺利地开发和解决问题。如果您有其他问题，欢迎在GitHub Issues中提出，或者参与NCF社区讨论。